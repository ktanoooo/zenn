---
title: "Kindleè³¼å…¥æ›¸ç±ã‚’CSVã§ä¿å­˜ã™ã‚‹"
emoji: "ğŸ¡"
type: "tech"
topics: ["javascript", "csv"]
published: true
---

# çµè«–ãƒ»ã‚„ã‚Šæ–¹

`Kindle for PC`ã‚‚ã—ãã¯`Kindle for Mac`ã‚’ä½¿ã£ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¯¾è±¡ã€‚
ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«è‡ªå‹•ã§`KindleSyncMetadataCache.xml`ã¨ã„ã† XML ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã“ã‚Œã‚’ parse ã—ã¦ã« CSV ã‚’ç”Ÿæˆã™ã‚‹ã€‚

## ç’°å¢ƒ

ä»–ã®ç’°å¢ƒã¯çŸ¥ã‚‰ãªã„ã€‚å¤šåˆ†å‹•ãã€‚

```bash
â¯ node -v
v16.13.2
â¯ npm -v
8.1.2
â¯ yarn -v
1.22.17
```

## æº–å‚™

```bash
git clone git@github.com:ktanoooo/kindle_csv.git
yarn
```

## å®Ÿè¡Œ

`run.sh`å®Ÿè¡Œæ™‚ã«`xmlã®ãƒ‘ã‚¹`ã¨`æ–‡å­—ã‚³ãƒ¼ãƒ‰`ã‚’å¼•æ•°ã«å…¥ã‚Œã‚‹å¿…è¦ã‚ã‚Šã€‚

- `xmlã®ãƒ‘ã‚¹`
  - ã¯ Windows ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯`{yourname}`ã®ã¨ã“ã‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥ã‚Œå¤‰ãˆã‚Œã°å‹•ãã¯ãšã€‚ã€‚ã€‚Mac ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãã®ã¾ã¾ä½¿ãˆã‚‹ã¯ãšã€‚
- `æ–‡å­—ã‚³ãƒ¼ãƒ‰`
  - [ã“ã¡ã‚‰](https://github.com/ashtuchkin/iconv-lite/wiki/Supported-Encodings)ãŒå¯¾å¿œã€‚

```bash
# Windows
/bin/bash run.sh /Users/{yourname}/AppData/Local/Amazon/Kindle/Cache/KindleSyncMetadataCache.xml Shift_JIS

# Windows (WSL)
/bin/bash run.sh /mnt/c/Users/{yourname}/AppData/Local/Amazon/Kindle/Cache/KindleSyncMetadataCache.xml Shift_JIS

# Mac (Kindle for Macã‚’AppStoreã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸäºº)
/bin/bash run.sh $HOME/Library/Containers/com.amazon.Kindle/Data/Library/Application Support/Kindle/Cache/KindleSyncMetadataCache.xml Shift_JIS

# Mac (Kindle for Macã‚’AppStoreä»¥å¤–ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸäºº)
/bin/bash run.sh $HOME/Library/Application Support/Kindle/Cache/KindleSyncMetadataCache.xml Shift_JIS
```

æ­£å¸¸ã«å®Œäº†ã™ã‚Œã°`./output/kindle-**.csv`ãŒç”Ÿæˆã•ã‚Œã‚‹ã€‚

https://github.com/ktanoooo/kindle_csv

# ãªãœ

æŠ€è¡“ç³»ã®é›‘èªŒã‚„æŠ€è¡“æ›¸ã¯ç¾ç‰©ä¸€æŠã ã¨æ€ã£ã¦ã„ãŸãŒã€æ¥ãšã‹ã—ãªãŒã‚‰æœ€è¿‘ Kindle ã®ç›®æ¬¡æ©Ÿèƒ½ã‚’çŸ¥ã£ã¦ Kindle ä¿¡è€…ã«ãªã£ãŸã€‚
ãŠã‹ã’ã§å†Šæ•°ãŒå¢—ãˆã¦ãã¦ CSV ã§ä¸€è¦§ç®¡ç†ãŒã—ãŸã‹ã£ãŸãŒã€ä»¥ä¸‹ã®è¨˜äº‹ãŒå¤ãã¦ä½¿ãˆãªã‹ã£ãŸã®ã§è‡ªåˆ†ã§ä½œã‚‹ã“ã¨ã«ã—ãŸã€‚
https://qiita.com/taka_hira/items/8a9181c0733de2c9f8ee
ã“ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã§`Kindle for PC`,`Kindle for Mac`ã§ã¯`KindleSyncMetadataCache.xml`ãŒåã‹ã‚Œã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã‚’æ•™ãˆã¦ãã‚Œã¦ãŸã®ã§ã“ã‚Œã‚’ä½¿ã†ã€‚

![KindleSyncMetadataCache.xml](/images/xml_sample.png)

# XML ã®å–å¾—

`KindleSyncMetadataCache.xml`ãŒã©ã“ã«ã‚ã‚‹ã®ã‹ã‚’ã¾ãšæ•´ç†ã—ãªã„ã¨ã„ã‘ãªã„ã€‚
Windows ã®äººã¯`Kindle for PC`, Mac ã®äººã¯`Kindle for Mac`ã¨ã„ã†ã®ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ä½¿ç”¨ã—ã¦ã„ã‚‹ã“ã¨ãŒå‰æã«ãªã‚‹ãŒã€ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ã„ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å¤§ä½“ä»¥ä¸‹ã®ãƒ‘ã‚¹ã«è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã¯ãšã€‚

- Windows
  - `/Users/{yourname}/AppData/Local/Amazon/Kindle/Cache/KindleSyncMetadataCache.xml`
- Windows(WSL)
  - `/mnt/c/Users/{yourname}/AppData/Local/Amazon/Kindle/Cache/KindleSyncMetadataCache.xml`
- Mac(Kindle for Mac ã‚’ AppStore çµŒç”±ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)
  - `$HOME/Library/Containers/com.amazon.Kindle/Data/Library/Application Support/Kindle/Cache/KindleSyncMetadataCache.xml`
- Mac(Kindle for Mac ã‚’ AppStore ä»¥å¤–ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)
  - `$HOME/Library/Application Support/Kindle/Cache/KindleSyncMetadataCache.xml`

Mac ã®äººã¯ä»¥ä¸‹ã®ã‚ˆã†ã«`Kindle for Mac`ã‚’é–‹ã„ã¦`Preferences`â†’`Content Folder`ã‹ã‚‰ç¢ºèªãŒã§ãã‚‹
![https://github.com/ktanoooo/kindle_csv/blob/main/public/mac2.png](/images/mac2.png)

# XML ã‚’ parse

ç„¡äº‹ xml ã®ãƒ‘ã‚¹ãŒåˆ†ã‹ã‚Œã°ãã‚Œã‚’ parse ã—ã¦ CSV ã«ç›´ã›ã°ã‚ˆã„ã€‚
[fast-xml-parser](https://github.com/NaturalIntelligence/fast-xml-parser)ã‚’ä½¿ã£ã¦ã¿ãŸã‹ã£ãŸã®ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®åŠ›ã‚’å€Ÿã‚Šã¦ node ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã«ã™ã‚‹ã€‚

`XML`ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãª HTML ã¿ãŸã„ãªæ§‹é€ ã«ãªã£ã¦ã„ã¦ parse ã™ã‚‹ã“ã¨ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ç›´ã—ã¦æ‰±ã„ã‚„ã™ãã—ã¦ãã‚Œã‚‹ã€‚

```xml
<response>
  <sync_time>
    2022-03-05T16:25:37+0000;softwareVersion:000000;***************-000000000000,Periodical-0000000000000,KB-00000000000000,
  </sync_time>
  <cache_metadata>
    <version>1</version>
  </cache_metadata>
  <add_update_list>
    <meta_data>...</meta_data>
  </add_update_lsit>
</response>
```

```js
{
  response: {
    sync_time: '2022-03-05T16:25:37+0000;softwareVersion:000000;***************-000000000000,Periodical-0000000000000,KB-00000000000000,',
    cache_metadata: { version: 1 },
    add_update_list: { meta_data: [Array] }
  }
}
```

å®Ÿéš›ã® parse å‡¦ç†ã¯ä»¥ä¸‹ã€‚
`output`ã«ä¸Šè¨˜ã®ã‚ˆã†ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå…¥ã‚‹ã€‚è³¼å…¥ã—ãŸæ›¸ç±ã§ã¯ãªã„ãƒ‡ãƒ¼ã‚¿ã‚‚å«ã¾ã‚Œã¦ã„ãŸãŸã‚ã€`filter`ã§è³¼å…¥æ—¥ä»˜ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã¿ã«çµã‚Šè¾¼ã‚“ã§ã„ã‚‹ã€‚

```js
const FastXMLParser = require("fast-xml-parser");

const parser = new FastXMLParser.XMLParser({ ignoreAttributes: false });
const output = parser.parse(text);
let purchasedData = output.response.add_update_list.meta_data.filter(
  (e) => !!e.purchase_date
);
```

# CSV ãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚‹

ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã—ã¦ã—ã¾ãˆã°ã‚ã¨ã¯ãƒ«ãƒ¼ãƒ—å›ã—ã¦ csv ã®å½¢ã«æ•´ãˆã¦ã„ãã ã‘ã€‚
æ›¸ç±ã®ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å–ã‚Œã‚‹ã®ã¯ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿

```js
{
  ASIN: 'B0000000',
  title: {
    '#text': 'Book name',
    '@_pronunciation': 'Book name'
  },
  authors: { author: { '#text': 'author name', '@_pronunciation': '' } },
  publishers: { publisher: 'publisher name' },
  publication_date: '2010-04-01T00:00:00+0000',
  purchase_date: '2019-01-01T00:00:00+0000',
  textbook_type: 'unknown',
  cde_contenttype: 'EBOK',
  content_type: 'application/x-mobipocket-ebook'
}
```

ã„ã‚‰ãªã„ãƒ‡ãƒ¼ã‚¿ã‚‚ã‚ã‚‹ã®ã§ä»Šå› CSV ã«è½ã¨ã—è¾¼ã‚€ã®ã¯`asin`, `title`, `author`, `publisher`, `publication_date`, `purchase_date`ã«çµã‚‹ã“ã¨ã«ã™ã‚‹ã€‚
`asin`ã¯æ›¸ç±ã® uniq id ã¿ãŸã„ãªã‚‚ã®ã€‚

å®Ÿéš›ã®å‡¦ç†ã¯ã“ã‚Œã€‚`normalize()`ã¯æ–‡å­—åˆ—ã«`"`, `,`ãŒå«ã¾ã‚Œã¦ã¦ã‚‚å¤§ä¸ˆå¤«ãªã‚ˆã†ã«åŠ å·¥ã™ã‚‹å‡¦ç†ã€‚

```js
const normalize = (str) => `"${str.replaceAll('"', "'")}"`;

const create_csv_data = (datas) => {
  let csvData = "";
  const header = [
    "asin",
    "title",
    "author",
    "publisher",
    "publication_date",
    "purchase_date",
  ];
  csvData += header.join() + "\n";

  datas.forEach((data) => {
    const {
      ASIN: asin,
      title: { "#text": titleText },
      authors: {
        author: { "#text": authorText },
      },
      publishers: { publisher },
      publication_date,
      purchase_date,
    } = data;

    csvData +=
      [asin, titleText, authorText, publisher, publication_date, purchase_date]
        .map((e) => normalize(e))
        .join(",") + "\n";
  });
  return csvData;
};
```

# CSV ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›

ç‰¹ã«å¿…è¦ãªã‹ã£ãŸãŒã¤ã„ã§ã«`utf8`ä»¥å¤–ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã«ã‚‚å¯¾å¿œã—ãŸã€‚
ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã«ã¯[iconv-lite](https://github.com/ashtuchkin/iconv-lite)ã‚’ä½¿ã†ã€‚
å¯¾å¿œã—ã¦ã„ã‚‹æ–‡å­—ã‚³ãƒ¼ãƒ‰ä¸€è¦§ã¯[ã“ã¡ã‚‰](https://github.com/ashtuchkin/iconv-lite/wiki/Supported-Encodings)

å®Ÿéš›ã«å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã«æœªå¯¾å¿œã®ä¸é©åˆ‡ãªæ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’æŒ‡å®šã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€åˆ¤å®šã™ã‚‹ãŸã‚ã«æ¯å› curl ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦`encodings_list.json`ã«ä¿å­˜ã™ã‚‹ã‚ˆã†ã«ã—ãŸã€‚é›‘ã ã‘ã©é »ç¹ã«å®Ÿè¡Œã™ã‚‹ã‚‚ã®ã§ã‚‚ãªã„ã—ã“ã‚Œã§ã„ã„ã‹ãªã¨æ€ã£ã¦ãã®ã¾ã¾ã€‚
https://gist.github.com/ktanoooo/54cb81d199560a006b61a2508aa0f5fb

```js
const fs = require("fs");
const path = require("path");
const iconv = require("iconv-lite");

const export_csv = (outputpath, data, charset) => {
  const list = fs.readFileSync(
    path.resolve(__dirname, "encodings_list.json"),
    "utf8"
  );
  if (list.includes(charset)) {
    fs.writeFile(outputpath, iconv.encode(data, charset), (err) => {
      if (err) throw err;
    });
  }
};
```
